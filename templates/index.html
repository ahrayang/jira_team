<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sol Project - Perforce ë³€ê²½ì‚¬í•­ ì¡°íšŒ</title>
  <style>
    body{font-family:'Segoe UI',Arial,sans-serif;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:0;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%);color:#fff;padding:30px;text-align:center}
    .header h1{margin:0 0 10px 0;font-size:2.5em}
    .header p{margin:0;font-size:1.2em;opacity:.9}
    .search-section{padding:30px;background:#f8f9fa;border-bottom:1px solid #e9ecef}
    button{background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);color:#fff;padding:12px 25px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;transition:all .3s}
    button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(52,152,219,.4)}
    button:disabled{background:#bdc3c7;cursor:not-allowed;transform:none;box-shadow:none}
    input,select{padding:10px;margin:5px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;transition:border-color .3s}
    input:focus,select:focus{outline:none;border-color:#3498db;box-shadow:0 0 0 3px rgba(52,152,219,.1)}
    .form-row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
    .form-group{flex:1;min-width:200px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#2c3c50}
    .depot-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0}
    .depot-item{display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border-radius:8px;border:2px solid #e9ecef;transition:all .3s}
    .depot-item:hover{background:#f8f9fa;border-color:#3498db}
    .depot-item input[type="checkbox"]{margin:0;transform:scale(1.2)}
    .result{padding:30px;background:#fff}
    .depot-section{margin-bottom:30px;border:2px solid #e9ecef;border-radius:10px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .depot-header{background:linear-gradient(135deg,#34495e 0%,#2c3e50 100%);color:#fff;padding:15px 20px;font-weight:600;font-size:18px}
    .user-section{padding:20px;border-bottom:1px solid #e9ecef}
    .user-header{background:linear-gradient(135deg,#ecf0f1 0%,#bdc3c7 100%);padding:12px 15px;margin-bottom:15px;border-radius:8px;font-weight:600;color:#2c3e50}
    .change-item{background:#fff;border:1px solid #e9ecef;border-radius:8px;margin-bottom:15px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .file-item{background:#f8f9fa;border-left:4px solid #3498db;padding:12px;margin:8px 0;border-radius:0 5px 5px 0}
    .file-item.edit{border-left-color:#28a745}.file-item.add{border-left-color:#007bff}.file-item.delete{border-left-color:#dc3545}.file-item.integrate{border-left-color:#6f42c1}
    .action-badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold;color:#fff;margin-right:8px;text-transform:uppercase}
    .action-edit{background:#28a745}.action-add{background:#007bff}.action-delete{background:#dc3545}.action-integrate{background:#6f42c1}
    .diff-button{background:#17a2b8;padding:6px 12px;font-size:12px;margin-top:8px}
    .loading{text-align:center;padding:40px;color:#7f8c8d;font-size:18px;display:none}
    .loading::before{content:"âš¡";display:block;font-size:3em;margin-bottom:15px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    /* diff í‘œ */
    .diff-table{width:100%;border-collapse:collapse}
    .diff-table th,.diff-table td{border:1px solid #718096;padding:8px;text-align:left;vertical-align:top}
    .diff-table th{background:#4a5568;color:#e2e8f0}
    .row-modified{background:#2d4a3e}
    .row-added{background:#2d4a4a}
    .row-removed{background:#4a2d2d}
    .row-error{background:#4a2d2d}
    .row-nochange{background:#4a5568;opacity:1;color:#a0aec0}
    code{color:#e2e8f0}
    .val-old{color:#f687b3}
    .val-new{color:#68d391}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sol Project</h1>
      <p>Perforce ë³€ê²½ì‚¬í•­ ì¡°íšŒ ì‹œìŠ¤í…œ</p>
    </div>

    <div class="search-section">
      <form id="searchForm">
        <div class="form-row">
          <div class="form-group">
            <label for="startDate">ì‹œì‘ ë‚ ì§œ</label>
            <input type="datetime-local" id="startDate" required>
          </div>
          <div class="form-group">
            <label for="endDate">ì¢…ë£Œ ë‚ ì§œ</label>
            <input type="datetime-local" id="endDate" required>
          </div>
          <div class="form-group">
            <label for="userFilter">ì‚¬ìš©ì í•„í„° (ì„ íƒ)</label>
            <input type="text" id="userFilter" placeholder="ì‚¬ìš©ìëª… ì…ë ¥">
          </div>
        </div>

        <div class="form-group">
          <label>ì €ì¥ì†Œ ì„ íƒ</label>
          <div class="depot-list">
            {% for depot in depots %}
            <div class="depot-item">
              <input type="checkbox" id="depot_{{ depot }}" name="depots" value="{{ depot }}">
              <label for="depot_{{ depot }}">{{ depot }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <button type="submit" id="searchBtn">ê²€ìƒ‰ ì‹œì‘</button>
      </form>
    </div>

    <div id="loading" class="loading">
      <p>Sol Project ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
    </div>

    <div id="result" class="result" style="display:none;"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(now.getMonth() - 1);
      
      // datetime-local í¬ë§·ìœ¼ë¡œ ë³€í™˜ (YYYY-MM-DDTHH:mm)
      document.getElementById('endDate').value = now.toISOString().slice(0, 16);
      document.getElementById('startDate').value = oneMonthAgo.toISOString().slice(0, 16);
      
      const checkbox = document.querySelector('input[value="Sol Dev1Next"]');
      if (checkbox) checkbox.checked = true;
    });

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const userFilter = document.getElementById('userFilter').value;
      const selectedDepots = Array.from(document.querySelectorAll('input[name="depots"]:checked')).map(cb => cb.value);
      if (selectedDepots.length === 0) { alert('ìµœì†Œ í•˜ë‚˜ì˜ ì €ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }

      // datetime-local í˜•ì‹ì„ Perforce í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const convertToPerforceDate = (dateTimeStr) => {
        if (!dateTimeStr) return '';
        const date = new Date(dateTimeStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        const second = '00';
        return `${year}/${month}/${day}:${hour}:${minute}:${second}`;
      };

      const searchBtn = document.getElementById('searchBtn');
      const loading = document.getElementById('loading');
      const resultDiv = document.getElementById('result');

      searchBtn.disabled = true; searchBtn.textContent = 'ê²€ìƒ‰ ì¤‘...';
      loading.style.display = 'block'; resultDiv.style.display = 'none';

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            start_date: convertToPerforceDate(startDate), 
            end_date: convertToPerforceDate(endDate), 
            depots: selectedDepots, 
            user_filter: userFilter 
          })
        });
        const data = await response.json();
        displayResults(data);
      } catch (error) {
        resultDiv.innerHTML = '<div style="color:red;padding:20px;text-align:center;">ì˜¤ë¥˜: ' + escapeHtml(error.message) + '</div>';
        resultDiv.style.display = 'block';
      } finally {
        searchBtn.disabled = false; searchBtn.textContent = 'ê²€ìƒ‰ ì‹œì‘';
        loading.style.display = 'none';
      }
    });

    function displayResults(data) {
      const resultDiv = document.getElementById('result');
      let html = '<h3>ê²€ìƒ‰ ê²°ê³¼</h3>';

      let totalChanges = 0;
      let totalUsers = 0;
      for (const [depotName, depotData] of Object.entries(data)) {
        if (!depotData || depotData.error) continue;
        totalUsers += Object.keys(depotData).length;
        for (const userData of Object.values(depotData)) {
          totalChanges += userData.total_changes || 0;
        }
      }
      if (totalChanges > 0) {
        html += `<div style="background:#f39c12;color:#fff;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;">
          <strong>ì´ ${totalChanges}ê°œ ë³€ê²½ì‚¬í•­ | ${totalUsers}ëª… ì‘ì—…ì</strong></div>`;
      }

      for (const [depotName, depotData] of Object.entries(data)) {
        html += `<div class="depot-section"><div class="depot-header">${escapeHtml(depotName)}</div>`;
        if (!depotData) { html += '<div style="padding:20px;color:#7f8c8d;text-align:center;">ê²°ê³¼ ì—†ìŒ</div></div>'; continue; }
        if (depotData.error) {
          html += `<div style="padding:20px;color:#e74c3c;text-align:center;"><strong>ì˜¤ë¥˜:</strong> ${escapeHtml(depotData.error)}</div></div>`;
          continue;
        }
        if (Object.keys(depotData).length === 0) {
          html += '<div style="padding:20px;color:#7f8c8d;text-align:center;">ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>'; continue;
        }

        for (const [userName, userData] of Object.entries(depotData)) {
          html += `<div class="user-section">
            <div class="user-header">${escapeHtml(userName)} (ì´ ${userData.total_changes}ê°œ ë³€ê²½ì‚¬í•­, ìµœê·¼ ${userData.changes.length}ê°œ í‘œì‹œ)</div>`;

          userData.changes.forEach((change, changeIndex) => {
            html += `<div class="change-item">
              <h4>Change ${escapeHtml(change.change_num)}</h4>
              <p><strong>ë‚ ì§œ:</strong> ${escapeHtml(change.date)} ${escapeHtml(change.time)}</p>
              <p><strong>ì„¤ëª…:</strong> ${escapeHtml(change.description || '')}</p>`;

            if (change.jira_urls) {
              const jiraLinks = change.jira_urls.split(', ').map(url =>
                `<a href="${url}" target="_blank" style="color:#3498db;">${escapeHtml(url)}</a>`
              ).join(', ');
              html += `<p><strong>Jira:</strong> ${jiraLinks}</p>`;
            }

            if (change.files && change.files.length > 0) {
              html += '<div style="margin-top:15px;"><strong>ë³€ê²½ëœ íŒŒì¼ë“¤:</strong></div>';
              change.files.forEach((file, fileIndex) => {
                // ì‚¬ìš©ìëª…ë„ í¬í•¨í•´ì„œ ì™„ì „íˆ ê³ ìœ í•œ ID ìƒì„±
                const diffId = `diff_${userName.replace(/[^a-zA-Z0-9]/g, '_')}_${change.change_num}_${fileIndex}`;
                html += `<div class="file-item ${escapeHtml(file.action)}">
                    <div>
                      <span class="action-badge action-${escapeHtml(file.action)}">${escapeHtml(file.action)}</span>
                      <strong>${escapeHtml(file.filename)}</strong>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:4px;">${escapeHtml(file.path)}${file.rev?`#${escapeHtml(file.rev)}`:''}</div>
                    <button class="diff-button" onclick="loadDiff('${escapeJs(change.change_num)}','${escapeJs(file.path)}','${diffId}','${escapeJs(file.rev||'')}')">
                      Diff ë³´ê¸°
                    </button>
                    <div id="${diffId}"></div>
                  </div>`;
              });
            }
            html += '</div>'; // change-item
          });

          html += '</div>'; // user-section
        }

        html += '</div>'; // depot-section
      }

      if (html === '<h3>ê²€ìƒ‰ ê²°ê³¼</h3>') {
        html += '<div style="padding:40px;text-align:center;color:#7f8c8d;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      resultDiv.innerHTML = html;
      resultDiv.style.display = 'block';
    }

    async function loadDiff(changelist, filePath, diffId, rev) {
      const diffDiv = document.getElementById(diffId);
      diffDiv.innerHTML = '<p style="color:#007bff;">JSON ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘...</p>';
      try {
        const requestBody = {
          changelist: changelist,
          file_path: filePath,
          rev: rev || undefined,
          force_nochange_row: true
        };
        
        console.log('ğŸ” Diff ìš”ì²­:', requestBody);
        
        const response = await fetch('/api/get-diff', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        console.log('ğŸ“¥ Diff ì‘ë‹µ:', data);
        console.log('ğŸ” data.success:', data.success);
        console.log('ğŸ” Array.isArray(data.changes):', Array.isArray(data.changes));
        console.log('ğŸ” data.changes:', data.changes);

        if (data.success && Array.isArray(data.changes)) {
          console.log(`âœ… Changes ê°œìˆ˜: ${data.changes.length}`);
          if (data.changes.length === 0) {
            console.log('âš ï¸ ë³€ê²½ì‚¬í•­ì´ 0ê°œë¼ì„œ early return');
            diffDiv.innerHTML = '<p style="color:#orange;padding:10px;background:#fff4e6;border-radius:4px;">ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          console.log('ğŸš€ renderDiffTable í˜¸ì¶œ ì§ì „');
          console.log('ğŸš€ diffDiv:', diffDiv);
          console.log('ğŸš€ data:', data);
          console.log('ğŸš€ diffId:', diffId);
          
          try {
            // ê¸°ì¡´ì˜ í•œ ë²ˆì— ë Œë”ë§í•˜ëŠ” ë°©ì‹ ëŒ€ì‹  ë°°ì¹˜ ë Œë”ë§ ì‚¬ìš©
            renderDiffTable(diffDiv, data, diffId);
            console.log('ğŸš€ renderDiffTable í˜¸ì¶œ ì™„ë£Œ');
          } catch (error) {
            console.error('ğŸš€ renderDiffTable ì˜¤ë¥˜:', error);
            diffDiv.innerHTML = `<p style="color:red;">ë Œë”ë§ ì˜¤ë¥˜: ${error.message}</p>`;
          }
        } else {
          console.error('âŒ API ì˜¤ë¥˜:', data);
          diffDiv.innerHTML = `<p style="color:red;padding:10px;background:#fee;border-radius:4px;">${escapeHtml(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')}</p>`;
        }
      } catch (error) {
        console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        diffDiv.innerHTML = `<p style="color:red;padding:10px;background:#fee;border-radius:4px;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${escapeHtml(error.message)}</p>`;
      }
    }

    // ë°°ì¹˜ ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€
    function renderDiffTable(diffDiv, data, diffId) {
      console.log(`ğŸ¨ renderDiffTable ì‹œì‘ - diffId: ${diffId}, totalChanges: ${data.changes.length}`);
      console.log(`ğŸ¨ ë°ì´í„° êµ¬ì¡°:`, data);
      
      const totalChanges = data.changes.length;
      const BATCH_SIZE = 50; // í•œë²ˆì— ë Œë”ë§í•  í–‰ ìˆ˜
      let currentBatch = 0;
      let isScrolled = false; // ìŠ¤í¬ë¡¤ ì—¬ë¶€ ì¶”ì 
      
      function renderBatch(batchIndex) {
        console.log(`ğŸ¨ renderBatch ${batchIndex} ì‹œì‘`);
        const start = batchIndex * BATCH_SIZE;
        const end = Math.min(start + BATCH_SIZE, totalChanges);
        const batchChanges = data.changes.slice(start, end);
        console.log(`ğŸ¨ ë°°ì¹˜ ë³€ê²½ì‚¬í•­:`, batchChanges);
        
        if (batchIndex === 0) {
          // ì²« ë°°ì¹˜: ì „ì²´ êµ¬ì¡° ìƒì„±
          console.log(`ğŸ¨ ì²« ë°°ì¹˜ - ì „ì²´ êµ¬ì¡° ìƒì„±`);
          const initialHtml = `
            <div style="background:#2d3748;color:#e2e8f0;padding:15px;border-radius:8px;margin-top:10px;">
              <div style="color:#a0aec0;margin-bottom:15px;border-bottom:1px solid #4a5568;padding-bottom:10px;">
                <strong>JSON ë³€ê²½ì‚¬í•­:</strong> ${escapeHtml(data.prev_version||'')} â†’ ${escapeHtml(data.curr_version||'')}
                <br><small>${escapeHtml(data.file_path||'')}</small>
                <br><span id="progress-${diffId}">ë¡œë”© ì¤‘... (0/${totalChanges})</span>
              </div>
              <div style="max-height:400px;overflow-y:auto;">
                <table class="diff-table" id="table-${diffId}">
                  <thead><tr><th>ì»¬ëŸ¼</th><th>ë³€ê²½ ìœ í˜•</th><th>ì´ì „ ê°’</th><th>í˜„ì¬ ê°’</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <button class="close-button" data-close-diff="${diffId}" style="margin-top:8px;">ë‹«ê¸°</button>
            <button class="export-excel" data-export-diff="${diffId}" style="margin-top:8px;margin-left:10px;background:#28a745;">Excel ë‚´ë³´ë‚´ê¸°</button>`;
          
          diffDiv.innerHTML = initialHtml;
          console.log(`ğŸ¨ HTML ì„¤ì • ì™„ë£Œ`);
          
          // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
          diffDiv.querySelector('[data-close-diff]').addEventListener('click', () => {
            diffDiv.innerHTML = '';
          });
          
          // Excel ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
          diffDiv.querySelector('[data-export-diff]').addEventListener('click', () => {
            exportDiffToExcel(data, diffId);
          });
        }
        
        // ë°°ì¹˜ ë Œë”ë§
        const tbody = diffDiv.querySelector(`#table-${diffId} tbody`);
        const progressSpan = diffDiv.querySelector(`#progress-${diffId}`);
        console.log(`ğŸ¨ í…Œì´ë¸” ìš”ì†Œ ì°¾ê¸° - tbody: ${!!tbody}, progressSpan: ${!!progressSpan}`);
        
        batchChanges.forEach((ch, index) => {
          console.log(`ğŸ¨ í–‰ ${index} ì²˜ë¦¬ ì¤‘:`, ch);
          const type = (ch.type||'').toLowerCase();
          let rowClass = 'row-nochange', typeText = 'nochange';
          if (type==='modified'){rowClass='row-modified';typeText='ìˆ˜ì •'}
          else if (type==='added'){rowClass='row-added';typeText='ì¶”ê°€'}
          else if (type==='removed'){rowClass='row-removed';typeText='ì‚­ì œ'}
          else if (type==='error'){rowClass='row-error';typeText='ì˜¤ë¥˜'}
          else if (type==='nochange'){typeText='ë³€ê²½ì‚¬í•­ ì—†ìŒ'}
          
          const keyName = simplifyPath(ch.path || '<root>');
          const oldVal = formatValue(ch.old_value);
          const newVal = formatValue(ch.new_value);
          
          console.log(`ğŸ¨ í–‰ ë°ì´í„° - type: ${type}, keyName: ${keyName}, oldVal: ${oldVal}, newVal: ${newVal}`);
          
          if (tbody) {
            const row = tbody.insertRow();
            row.className = rowClass;
            
            if (type === 'nochange') {
              row.innerHTML = `
                <td><code>${escapeHtml(keyName)}</code></td>
                <td style="font-weight:bold;color:#a0aec0;">${escapeHtml(typeText)}</td>
                <td colspan="2" style="color:#a0aec0;text-align:center;font-style:italic;">íŒŒì¼ì— êµ¬ì¡°ì  ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</td>`;
            } else if (type === 'error') {
              row.innerHTML = `
                <td><code>${escapeHtml(keyName)}</code></td>
                <td style="font-weight:bold;color:#dc3545;">íŒŒì‹± ì˜¤ë¥˜</td>
                <td colspan="2" style="color:#dc3545;font-weight:bold;">${escapeHtml(ch.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')}</td>`;
            } else {
              row.innerHTML = `
                <td><code>${escapeHtml(keyName)}</code></td>
                <td style="font-weight:bold;">${escapeHtml(typeText)}</td>
                ${
                  type === 'error'
                  ? `<td colspan="2" style="color:#fca5a5;">${escapeHtml(ch.message || 'ì˜¤ë¥˜')}</td>`
                  : `<td><code class="val-old">${escapeHtml(oldVal)}</code></td>
                     <td><code class="val-new">${escapeHtml(newVal)}</code></td>`
                }`;
            }
            console.log(`ğŸ¨ í–‰ ì¶”ê°€ ì™„ë£Œ - rowClass: ${rowClass}`);
          } else {
            console.error(`ğŸ¨ tbodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!`);
          }
        });
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        const loaded = end;
        if (progressSpan) {
          if (loaded >= totalChanges) {
            progressSpan.textContent = `ì™„ë£Œ! ì´ ${totalChanges}ê°œ ë³€ê²½ì‚¬í•­`;
          } else {
            progressSpan.textContent = `ë¡œë”© ì¤‘... (${loaded}/${totalChanges})`;
          }
        }
        
        // ë‹¤ìŒ ë°°ì¹˜ ë¡œë”© (ìŠ¤í¬ë¡¤ ì—†ì´)
        if (end < totalChanges) {
          setTimeout(() => renderBatch(batchIndex + 1), 10); // 10ms í›„ ë‹¤ìŒ ë°°ì¹˜
        } else {
          console.log(`ğŸ¨ renderDiffTable ì™„ë£Œ!`);
          // ìŠ¤í¬ë¡¤ ì œê±° - í˜„ì¬ ìœ„ì¹˜ì—ì„œ diff í‘œì‹œ
        }
      }
      
      renderBatch(0);
    }

    // Excel ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
    function exportDiffToExcel(data, diffId) {
      // í˜„ì¬ ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
      const today = new Date();
      const dateStr = today.getFullYear() + 
        String(today.getMonth() + 1).padStart(2, '0') + 
        String(today.getDate()).padStart(2, '0');
      
      // íŒŒì¼ ê²½ë¡œì—ì„œ ì €ì¥ì†Œëª… ì¶”ì¶œ
      const filePath = data.file_path || '';
      let depot = 'Unknown';
      if (filePath.includes('Sol/Dev1Next')) depot = 'SolDev1Next';
      else if (filePath.includes('Sol/Dev1')) depot = 'SolDev1';
      else if (filePath.includes('Sol/Dev2')) depot = 'SolDev2';
      else if (filePath.includes('Sol/Main')) depot = 'SolMain';
      else if (filePath.includes('Sol/Staging')) depot = 'SolStaging';
      
      // change ë²ˆí˜¸ ì¶”ì¶œ (diffIdì—ì„œ)
      const changeMatch = diffId.match(/_(\d+)_/);
      const changeNum = changeMatch ? changeMatch[1] : 'Unknown';
      
      // íŒŒì¼ëª… ìƒì„±
      const fileName = `${changeNum}_${depot}_${dateStr}.csv`;
      
      // CSV ë°ì´í„° ìƒì„± (UTF-8 BOM ì¶”ê°€)
      let csvContent = "\uFEFFêµ¬ë¶„,ì»¬ëŸ¼,ë³€ê²½ìœ í˜•,ì´ì „ê°’,í˜„ì¬ê°’\n";
      
      data.changes.forEach((change, index) => {
        const type = change.type || '';
        const path = change.path || '<root>';
        const oldVal = change.old_value !== null && change.old_value !== undefined ? String(change.old_value) : '';
        const newVal = change.new_value !== null && change.new_value !== undefined ? String(change.new_value) : '';
        
        let typeText = type;
        if (type === 'modified') typeText = 'ìˆ˜ì •';
        else if (type === 'added') typeText = 'ì¶”ê°€';
        else if (type === 'removed') typeText = 'ì‚­ì œ';
        else if (type === 'error') typeText = 'ì˜¤ë¥˜';
        else if (type === 'nochange') typeText = 'ë³€ê²½ì‚¬í•­ì—†ìŒ';
        
        const keyName = simplifyPath(path);
        
        // CSV ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        const escapeCsv = (str) => {
          if (str.includes('"') || str.includes(',') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        };
        
        csvContent += `${index + 1},${escapeCsv(keyName)},${escapeCsv(typeText)},${escapeCsv(oldVal)},${escapeCsv(newVal)}\n`;
      });
      
      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ (UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ ëª…ì‹œ)
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ----- Helper -----
    function simplifyPath(p) {
      // ë°°ì—´ ì¸ë±ìŠ¤/ì‹ë³„ì í‘œê¸°([0], [rid=..]) ì œê±°í•˜ê³  ë§ˆì§€ë§‰ í‚¤ë§Œ í‘œì‹œ
      if (!p) return '<root>';
      // ì ìœ¼ë¡œ ë¶„ë¦¬
      let parts = p.split('.');
      // ë§ˆì§€ë§‰ ìœ íš¨ ì„¸ê·¸ë¨¼íŠ¸ ì°¾ê¸°
      let last = parts[parts.length - 1];
      // ì˜ˆ: "[rid=123]" ë˜ëŠ” "name[0]" ê°™ì€ ê²½ìš° ë¸Œë¼ì¼“ ì œê±°
      // ìš°ì„  ì „ì²´ ê²½ë¡œì—ì„œ ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸ì˜ í‚¤ë§Œ ì¶”ì¶œ
      // ì„¸ê·¸ë¨¼íŠ¸ ì•ˆì— '['ê°€ ìˆìœ¼ë©´ ê·¸ ì•ë¶€ë¶„ í‚¤ë§Œ ì·¨í•¨
      if (last.includes('[')) {
        last = last.split('[')[0] || last;
      }
      // ë¹ˆ ë¬¸ìì—´ì´ë©´ ìƒìœ„ì—ì„œ ë‹¤ì‹œ íƒìƒ‰
      if (!last) {
        for (let i = parts.length - 1; i >= 0; i--) {
          let seg = parts[i];
          if (!seg) continue;
          if (seg.includes('[')) seg = seg.split('[')[0] || seg;
          if (seg) { last = seg; break; }
        }
      }
      return last || '<root>';
    }

    function formatValue(v) {
      if (v === undefined) return '';
      if (v === null) return 'null';
      if (typeof v === 'object') {
        try { return JSON.stringify(v); } catch { return String(v); }
      }
      return String(v);
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    function escapeJs(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/['"\\]/g, '\\$&');
    }
  </script>
</body>
</html>